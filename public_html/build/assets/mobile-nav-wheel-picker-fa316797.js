class f{constructor(){this.container=null,this.iconsContainer=null,this.items=[],this.centerPoint=0,this.sidePadding=16,this.isInitialized=!1,this.activeIconId=null,this.originalIcons=new Map,this.init(),this.checkEditorPage(),window.addEventListener("popstate",()=>this.checkEditorPage())}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.findElements()}):setTimeout(()=>this.findElements(),100)}findElements(){if(this.container=document.getElementById("nav-scroll-container"),this.iconsContainer=document.getElementById("nav-icons-container"),!this.container||!this.iconsContainer){console.warn("MobileNavCore: Не все элементы найдены, повторная попытка через 500ms"),setTimeout(()=>this.findElements(),500);return}this.items=Array.from(this.iconsContainer.querySelectorAll(".mb-icon-wrapper")),this.calculateCenterPoint(),this.items.length>0&&(this.isInitialized=!0,console.log("MobileNavCore: Навигация инициализирована"))}calculateCenterPoint(){this.centerPoint=this.container?this.container.offsetWidth/2:0}hideNavigation(){const t=document.querySelector(".mb-navigation");t&&t.classList.add("mb-nav-hidden")}showNavigation(){const t=document.querySelector(".mb-navigation");t&&t.classList.remove("mb-nav-hidden")}convertIconToBackButton(t){if(!this.isInitialized)return!1;this.activeIconId&&this.activeIconId!==t&&this.restoreIcon(this.activeIconId);const e=this.items.find(o=>o.getAttribute("data-icon-id")===t);if(!e)return console.warn(`MobileNavCore: Иконка с ID ${t} не найдена`),!1;const i=e.querySelector("a"),s=e.querySelector(".mb-nav-icon");return i&&s?(this.originalIcons.has(t)||this.originalIcons.set(t,{link:i.getAttribute("href"),img:s.getAttribute("src"),classes:e.className,linkClasses:i.className}),i.setAttribute("href","javascript:void(0);"),i.classList.add("mb-nav-back-btn"),s.setAttribute("src","/images/icons/arrow-left.svg"),e.classList.add("back-button-active"),i._closeModalHandler&&i.removeEventListener("click",i._closeModalHandler),i._closeModalHandler=o=>(o.preventDefault(),o.stopPropagation(),console.log('Нажата кнопка "Назад" для закрытия модального окна'),window.modalPanel&&window.modalPanel.closeModal(),!1),i.addEventListener("click",i._closeModalHandler),i.onclick=i._closeModalHandler,this.activeIconId=t,!0):!1}restoreIcon(t){if(!this.isInitialized||!this.originalIcons.has(t))return!1;const e=this.items.find(n=>n.getAttribute("data-icon-id")===t);if(!e)return console.warn(`MobileNavCore: Иконка с ID ${t} для восстановления не найдена`),!1;const i=this.originalIcons.get(t),s=e.querySelector("a"),o=e.querySelector(".mb-nav-icon");return s&&o&&i?(s._closeModalHandler&&(s.removeEventListener("click",s._closeModalHandler),delete s._closeModalHandler),s.setAttribute("href",i.link),s.className=i.linkClasses,o.setAttribute("src",i.img),e.className=i.classes,s.onclick=null,this.originalIcons.delete(t),this.activeIconId===t&&(this.activeIconId=null),!0):!1}checkEditorPage(){const t=window.location.href;/\/templates\/editor\/\d+/.test(t)||/\/client\/templates\/editor\/\d+/.test(t)?(this.ensureNavigationVisible(),document.documentElement.classList.add("editor-page"),console.log("Редактор обнаружен: "+t)):document.documentElement.classList.remove("editor-page")}ensureNavigationVisible(){const t=document.querySelector(".mb-navigation");t&&(t.style.display="flex",t.classList.remove("mb-nav-hidden"),t.classList.add("mb-nav-force-visible"),console.log("Навигационная панель принудительно отображена"))}}class g{constructor(t,e,i){this.core=t,this.scroll=e,this.popup=i,this.state={touchStartX:0,touchStartY:0,isTouchMoved:!1,isLongPress:!1,activeIconId:null,lastInteractionTime:0},this.timers={longPress:null,debounce:null},this.constants={longPressDelay:500,debounceDelay:300,minSwipeDistance:30},this._eventHandlers=new Map,this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.setupEventListeners()}):setTimeout(()=>this.setupEventListeners(),100)}setupEventListeners(){if(!this.core||!this.core.container){console.warn("MobileNavEvents: Необходимо инициализировать ядро навигации"),setTimeout(()=>this.setupEventListeners(),500);return}this.setupModalListeners(),this.setupTouchEvents(),this.setupClickEvents(),console.log("MobileNavEvents: События успешно инициализированы")}setupModalListeners(){const t=e=>{const i=e.type,s=e.detail||{},o=s.modalId,n=s.sourceIconId;i==="modal.opened"?(console.log("⚡️ Модальное окно открыто:",{modalId:o,sourceIconId:n}),o&&n&&(this.state.activeIconId===n&&this.core.restoreIcon(n),this.state.activeIconId=n,this.core.convertIconToBackButton(n))):i==="modal.closed"&&(console.log("⚡️ Модальное окно закрыто:",{modalId:o,activeIconId:this.state.activeIconId}),o&&this.state.activeIconId&&(this.core.restoreIcon(this.state.activeIconId),this.state.activeIconId=null))};document.addEventListener("modal.opened",t),document.addEventListener("modal.closed",t),this.injectModalSystemHandlers()}injectModalSystemHandlers(){if(!(!window.modalPanel||window.modalPanel._methodsModified))try{const t=window.modalPanel.openModal,e=window.modalPanel.closeModal;window.modalPanel.openModal=i=>{const s=Date.now();if(s-this.state.lastInteractionTime<this.constants.debounceDelay)return!1;this.state.lastInteractionTime=s;const o=t.call(window.modalPanel,i);if(o){let n=this.getModalSourceInfo(i);n&&this.triggerModalEvent("modal.opened",{modalId:i,sourceIconId:n.iconId})}return o},window.modalPanel.closeModal=(i=!1)=>{var n;const s=(n=window.modalPanel.activeModal)==null?void 0:n.id,o=e.call(window.modalPanel,i);return s&&this.triggerModalEvent("modal.closed",{modalId:s}),o},window.modalPanel._methodsModified=!0,console.log("MobileNavEvents: Методы модальной системы успешно модифицированы")}catch(t){console.error("MobileNavEvents: Ошибка при модификации методов модальной системы:",t)}}getModalSourceInfo(t){var e,i,s,o;return(i=(e=window.modalPanel)==null?void 0:e.modalSources)!=null&&i.has(t)?window.modalPanel.modalSources.get(t):(o=(s=this.popup)==null?void 0:s.modalTriggers)!=null&&o.has(t)?this.popup.modalTriggers.get(t):null}triggerModalEvent(t,e={}){const i=new CustomEvent(t,{detail:e});document.dispatchEvent(i)}setupTouchEvents(){this._addEventHandler(this.core.container,"touchstart",t=>{const e=t.touches[0];this.state.touchStartX=e.clientX,this.state.touchStartY=e.clientY,this.state.isTouchMoved=!1,this.state.isLongPress=!1;const i=document.elementFromPoint(this.state.touchStartX,this.state.touchStartY),s=i?i.closest(".mb-icon-wrapper"):null;s&&(s.classList.add("mb-touch-active"),clearTimeout(this.timers.longPress),this.timers.longPress=setTimeout(()=>{this.state.isTouchMoved||(this.state.isLongPress=!0,this.handleLongPress(s))},this.constants.longPressDelay))},{passive:!0}),this._addEventHandler(this.core.container,"touchmove",t=>{if(this.state.touchStartX&&this.state.touchStartY){const e=t.touches[0],i=Math.abs(e.clientX-this.state.touchStartX),s=Math.abs(e.clientY-this.state.touchStartY);(i>10||s>10)&&(this.state.isTouchMoved=!0,clearTimeout(this.timers.longPress),document.querySelectorAll(".mb-touch-active").forEach(o=>{o.classList.remove("mb-touch-active")}))}},{passive:!0}),this._addEventHandler(this.core.container,"touchend",()=>{clearTimeout(this.timers.longPress),document.querySelectorAll(".mb-touch-active").forEach(t=>{t.classList.remove("mb-touch-active")})},{passive:!0})}setupClickEvents(){document.addEventListener("click",t=>{const e=Date.now();if(e-this.state.lastInteractionTime<this.constants.debounceDelay){t.preventDefault(),t.stopPropagation();return}this.state.lastInteractionTime=e;const i=t.target.closest('[data-icon-id][data-modal="true"]');if(i){t.preventDefault(),t.stopPropagation();const s=i.getAttribute("data-modal-target"),o=i.getAttribute("data-icon-id");s&&o&&(this.popup.modalTriggers.set(s,{element:i,iconId:o}),o==="qr-scanner"&&window.qrScannerController?window.qrScannerController.open(t):window.modalPanel&&window.modalPanel.openModal(s))}})}handleLongPress(t){const e=t.getAttribute("data-icon-id");e&&(t.classList.add("mb-long-press"),this.provideTactileFeedback(50),setTimeout(()=>{this.popup&&typeof this.popup.showPopup=="function"&&this.popup.showPopup(e),t.classList.remove("mb-long-press","mb-touch-active")},150))}provideTactileFeedback(t=30){var i;if((((i=this.popup)==null?void 0:i.userHasInteracted)===!0||window.userHasInteractedWithPage===!0)&&navigator.vibrate&&!window.matchMedia("(prefers-reduced-motion: reduce)").matches)try{navigator.vibrate(Math.min(t,20))}catch{}}_addEventHandler(t,e,i,s={}){if(!t)return;this._eventHandlers.has(t)||this._eventHandlers.set(t,new Map);const o=this._eventHandlers.get(t);o.has(e)||o.set(e,[]),o.get(e).push(i),t.addEventListener(e,i,s)}destroy(){Object.values(this.timers).forEach(t=>{t&&clearTimeout(t)}),this._eventHandlers.forEach((t,e)=>{t.forEach((i,s)=>{i.forEach(o=>{e.removeEventListener(s,o)})})}),this._eventHandlers.clear()}}class v{constructor(t){this.core=t,this.isScrolling=!1,this.scrollTimeout=null,this.animationFrame=null,this.isCentering=!1,this.centeringQueue=[],this.lastDebounceTime=0,this.debounceThreshold=150,this.lastScrollLeft=0,this.scrollDirection=0,this.debounceTimeout=null,this.lastPageScroll=0,this.pageScrollTimeout=null,this.pageScrollThreshold=10,this.hideNavigationTimeout=null,this.isNavigationHidden=!1,this.lastUserActionTime=Date.now(),this.inactivityTimeout=null,this.inactivityThreshold=1500,this.inertiaEnabled=!0,this.inertiaFactor=.92,this.inertiaThreshold=.5,this.momentumValue=0,this.rafId=null,this.userHasInteracted=!1,this.initUserInteractionTracking(),this.lastScrollTime=0,this.setupScrollTimeTracking(),this._eventHandlers=new Map,this._scrollBlocked=!1,this._originalBodyStyles=null,this._savedScrollY=0,this.setupPageScrollListener()}setupScrollTimeTracking(){document.readyState==="loading"?this._addSafeEventListener(document,"DOMContentLoaded",()=>{this.setupScrollListener()}):setTimeout(()=>this.setupScrollListener(),100)}setupScrollListener(){this.core&&this.core.container?this._addSafeEventListener(this.core.container,"scroll",()=>{this.lastScrollTime=Date.now()},{passive:!0}):setTimeout(()=>this.setupScrollListener(),500)}_addSafeEventListener(t,e,i,s={}){if(!t)return;this._eventHandlers.has(t)||this._eventHandlers.set(t,new Map);const o=this._eventHandlers.get(t);o.has(e)||o.set(e,[]),o.get(e).push(i),t.addEventListener(e,i,s)}_removeSafeEventListener(t,e,i=null){if(!t||!this._eventHandlers.has(t))return;const s=this._eventHandlers.get(t);if(s.has(e))if(i){const o=s.get(e),n=o.indexOf(i);n!==-1&&(t.removeEventListener(e,i),o.splice(n,1))}else s.get(e).forEach(o=>{t.removeEventListener(e,o)}),s.delete(e)}applyInertia(t){if(!this.inertiaEnabled||Math.abs(t)<this.inertiaThreshold)return;this.momentumValue=t*15,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null);const e=()=>{if(!this.core||!this.core.container){this.rafId=null;return}Math.abs(this.momentumValue)>this.inertiaThreshold?(this.core.container.scrollLeft+=this.momentumValue,this.momentumValue*=this.inertiaFactor,this.rafId=requestAnimationFrame(e)):this.rafId=null};this.rafId=requestAnimationFrame(e)}detectScrollContainer(){if(!this.core.container){const t=document.getElementById("nav-scroll-container");return t?(this.core.container=t,!0):!1}return!0}showModalPanel(t,e={}){if(window.modalPanel)return window.modalPanel.openModal(t);const i=document.getElementById(t);if(!i)return!1;this.blockBodyScroll(),i.classList.add("show","animate-in"),i.style.display="flex";const s=document.querySelector(".modal-backdrop");return s&&s.classList.add("show"),!0}hideModalPanel(t){if(window.modalPanel)return window.modalPanel.closeModal();const e=document.getElementById(t);if(!e)return!1;e.classList.remove("animate-in"),e.classList.add("animate-out");const i=document.querySelector(".modal-backdrop");return i&&i.classList.remove("show"),setTimeout(()=>{e.classList.remove("show","animate-out"),e.style.display="none",this.unblockBodyScroll()},300),!0}blockBodyScroll(){this._scrollBlocked||(this._savedScrollY=window.pageYOffset||document.documentElement.scrollTop,this._originalBodyStyles={overflow:document.body.style.overflow,position:document.body.style.position,top:document.body.style.top,width:document.body.style.width},document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.top=`-${this._savedScrollY}px`,document.body.style.width="100%",document.body.classList.add("modal-scroll-blocked"),this._scrollBlocked=!0)}unblockBodyScroll(){var t;this._scrollBlocked&&(document.body.style.overflow="",document.body.style.position="",document.body.style.top="",document.body.style.width="",document.body.style.paddingRight="",(document.body.getAttribute("style")===""||(t=document.body.getAttribute("style"))!=null&&t.includes("/*"))&&document.body.removeAttribute("style"),document.body.classList.remove("modal-scroll-blocked"),this._savedScrollY!==void 0&&window.scrollTo(0,this._savedScrollY),this._scrollBlocked=!1,this._originalBodyStyles=void 0,this._savedScrollY=void 0)}destroy(){this._eventHandlers.forEach((t,e)=>{t.forEach((i,s)=>{i.forEach(o=>{e.removeEventListener(s,o)})})}),this._eventHandlers.clear(),this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.scrollTimeout&&clearTimeout(this.scrollTimeout),this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.pageScrollTimeout&&clearTimeout(this.pageScrollTimeout),this.hideNavigationTimeout&&clearTimeout(this.hideNavigationTimeout),this.inactivityTimeout&&clearTimeout(this.inactivityTimeout)}setupPageScrollListener(){this._addSafeEventListener(window,"scroll",()=>{this.handlePageScroll()},{passive:!0}),this.setupTouchListeners(),this.setupInactivityDetection(),this.setupUserActivityListeners()}setupTouchListeners(){let t=null,e=null,i=null,s=null;this._addSafeEventListener(document,"touchstart",o=>{t=o.touches[0].clientY,i=null,this.registerUserActivity()},{passive:!0}),this._addSafeEventListener(document,"touchmove",o=>{s||(s=setTimeout(()=>{if(s=null,!t)return;e=o.touches[0].clientY;const n=t-e;Math.abs(n)>10&&(n<0&&i!=="down"?(i="down",this.showNavigation()):n>30&&i!=="up"&&(i="up",this.isInExcludedPath()||this.hideNavigation()))},100))},{passive:!0}),this._addSafeEventListener(document,"touchend",()=>{s&&(clearTimeout(s),s=null),t=null,e=null,this.registerUserActivity()},{passive:!0})}isInExcludedPath(){const t=window.location.pathname;return["/templates/create-new/","/templates/editor","/client/templates/create-new/","/client/templates/editor"].some(i=>t.includes(i))}handlePageScroll(){document.querySelector(".mb-navigation")&&(this.lastUserActionTime=Date.now(),this.pageScrollAnimationFrame&&cancelAnimationFrame(this.pageScrollAnimationFrame),this.pageScrollAnimationFrame=requestAnimationFrame(()=>{const e=window.pageYOffset||document.documentElement.scrollTop;if(this.lastPageScroll===void 0||this.lastPageScroll===0){this.lastPageScroll=e;return}this.pageScrollTimeout&&clearTimeout(this.pageScrollTimeout),this.inactivityTimeout&&clearTimeout(this.inactivityTimeout);const i=!this.isInExcludedPath(),s=e-this.lastPageScroll,o=Math.abs(s)>this.pageScrollThreshold;i&&o&&(s>0&&e>50?this.hideNavigation():s<0&&this.showNavigation()),this.pageScrollTimeout=setTimeout(()=>{Date.now()-this.lastUserActionTime>=this.inactivityThreshold&&this.showNavigation()},this.inactivityThreshold),this.setupInactivityDetection(),this.lastPageScroll=e}))}setupInactivityDetection(){this.inactivityTimeout&&clearTimeout(this.inactivityTimeout),this.inactivityTimeout=setTimeout(()=>{this.isNavigationHidden&&this.showNavigation()},this.inactivityThreshold*1.5)}hideNavigation(){const t=document.querySelector(".mb-navigation");if(!(!t||this.isNavigationHidden)){if(this.isInExcludedPath()){console.log("Скрытие навигации пропущено на странице редактора");return}requestAnimationFrame(()=>{t.classList.add("mb-nav-hidden"),t.classList.remove("mb-nav-loaded"),this.isNavigationHidden=!0,this.hideNavigationTimeout&&clearTimeout(this.hideNavigationTimeout),this.hideNavigationTimeout=setTimeout(()=>{this.setupInactivityDetection()},100)})}}showNavigation(){const t=document.querySelector(".mb-navigation");!t||!this.isNavigationHidden||(this.hideNavigationTimeout&&clearTimeout(this.hideNavigationTimeout),this.canUseVibrateAPI()&&navigator.vibrate(5),requestAnimationFrame(()=>{t.classList.remove("mb-nav-hidden"),this.isNavigationHidden=!1,this.lastUserActionTime=Date.now(),this.inactivityTimeout&&clearTimeout(this.inactivityTimeout),this.setupInactivityDetection()}))}canUseVibrateAPI(){return navigator.vibrate&&this.userHasInteracted&&window.userHasInteractedWithPage===!0&&!window.matchMedia("(prefers-reduced-motion: reduce)").matches}initUserInteractionTracking(){const t=()=>{this.userHasInteracted=!0,window.userHasInteractedWithPage=!0,document.removeEventListener("click",t,{capture:!0}),document.removeEventListener("touchstart",t,{capture:!0}),document.removeEventListener("keydown",t,{capture:!0})};document.addEventListener("click",t,{passive:!0,capture:!0}),document.addEventListener("touchstart",t,{passive:!0,capture:!0}),document.addEventListener("keydown",t,{passive:!0,capture:!0}),typeof window.userHasInteractedWithPage>"u"&&(window.userHasInteractedWithPage=!1),Object.getOwnPropertyDescriptor(window,"userHasInteractedWithPage")||Object.defineProperty(window,"userHasInteractedWithPage",{get:()=>this.userHasInteracted,set:e=>{e===!0&&(this.userHasInteracted=!0)},configurable:!1})}}class b{constructor(t){this.core=t,this.isPopupOpen=!1,this.currentPopupConfig=null,this.popupContainer=null,this.backdrop=null,this.swipeStartY=0,this.swipeStartX=0,this.isSwipeDetected=!1,this.minSwipeDistance=50,this.isUpSwipeInProgress=!1,this.popupConfigs={},this.userHasInteracted=!1,this.swipeTargetElement=null,this.swipeTargetIconId=null,this.modalTriggers=new Map,this.originalBodyOverflow="",this.originalBodyPosition="",this.scrollY=0,this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.delayedInit()}):this.delayedInit()}delayedInit(){setTimeout(()=>{this.createPopupElements(),this.loadPopupConfigsFromHtml(),this.setupSwipeDetection()},500)}loadPopupConfigsFromHtml(){const t=document.getElementById("mobile-nav-popup-configs");if(!t){console.warn("Элемент #mobile-nav-popup-configs не найден, используются запасные конфигурации"),this.popupConfigs=this.getFallbackPopupConfigs();return}t.querySelectorAll("[data-popup-config]").forEach(i=>{var a;const s=i.getAttribute("data-popup-config"),o=((a=i.querySelector(".popup-config-title"))==null?void 0:a.textContent)||"",n=[];i.querySelectorAll(".popup-item").forEach(l=>{const d=l.getAttribute("data-icon"),h=l.getAttribute("data-href")||"#",u=l.getAttribute("data-modal")==="true",p=l.getAttribute("data-modal-target")||null,m=l.getAttribute("data-title")||"";n.push({icon:d,href:h,title:m,isModal:u,modalId:p})}),n.length>0&&(this.popupConfigs[s]={title:o,items:n})}),Object.keys(this.popupConfigs).length===0&&(this.popupConfigs=this.getFallbackPopupConfigs())}getFallbackPopupConfigs(){return{home:{title:"Главная",items:[{icon:"newspaper.svg",href:"/news",isModal:!1,title:"Новости"},{icon:"calendar.svg",href:"/events",isModal:!1,title:"События"},{icon:"info-circle.svg",href:"/about",isModal:!1,title:"О нас"}]},profile:{title:"Профиль",items:[{icon:"gear.svg",href:"/profile/settings",isModal:!1,title:"Настройки"},{icon:"clock-history.svg",href:"/user/templates",isModal:!1,title:"История"},{icon:"heart.svg",href:"/user/favorites",isModal:!1,title:"Избранное"}]},create:{title:"Создать",items:[{icon:"file-earmark.svg",href:"/client/templates/categories",isModal:!1,title:"Шаблоны"},{icon:"folder-plus.svg",href:"/client/projects",isModal:!1,title:"Проекты"},{icon:"image.svg",href:"/client/images",isModal:!1,title:"Изображения"}]},games:{title:"Развлечения",items:[{icon:"puzzle.svg",href:"/games/puzzle",isModal:!1,title:"Пазлы"},{icon:"controller.svg",href:"/games/arcade",isModal:!1,title:"Аркады"},{icon:"trophy.svg",href:"/games/tournaments",isModal:!1,title:"Турниры"}]},email:{title:"Почта",items:[{icon:"inbox.svg",href:"/email/inbox",isModal:!1,title:"Входящие"},{icon:"send.svg",href:"/email/sent",isModal:!1,title:"Отправленные"},{icon:"pencil.svg",href:"/email/compose",isModal:!1,title:"Написать"}]},admin:{title:"Администрирование",items:[{icon:"people.svg",href:"/admin/users",isModal:!1,title:"Пользователи"},{icon:"bar-chart.svg",href:"/admin/statistics",isModal:!1,title:"Статистика"},{icon:"gear.svg",href:"/admin/settings",isModal:!1,title:"Настройки"}]},"qr-scanner":{title:"QR Сканер",items:[{icon:"qr-code.svg",href:"#",isModal:!0,modalId:"qr-scanner-modal",title:"Сканировать"},{icon:"camera.svg",href:"#",isModal:!0,modalId:"camera-modal",title:"Камера"},{icon:"image.svg",href:"/qr/history",isModal:!1,title:"История"}]}}}createPopupElements(){this.backdrop=document.createElement("div"),this.backdrop.className="mb-popup-backdrop",this.popupContainer=document.createElement("div"),this.popupContainer.className="mb-popup-container mb-popup-swipeable";const t=document.createElement("div");t.className="mb-swipe-indicator",this.popupContainer.appendChild(t),document.body.appendChild(this.backdrop),document.body.appendChild(this.popupContainer),this.backdrop.addEventListener("click",()=>this.closePopup()),this.popupContainer.addEventListener("touchstart",e=>{this.swipeStartY=e.touches[0].clientY}),this.popupContainer.addEventListener("touchend",e=>{e.changedTouches[0].clientY-this.swipeStartY>this.minSwipeDistance&&this.closePopup()})}setupSwipeDetection(){if(!this.core.container){const t=document.getElementById("nav-scroll-container");if(t)this.core.container=t;else return}this.core.container.addEventListener("touchstart",t=>{this.userHasInteracted=!0;const e=t.touches[0],i=e.clientX,s=e.clientY,o=Array.from(this.core.iconsContainer.querySelectorAll(".mb-icon-wrapper"));let n=null;for(const c of o){const a=c.getBoundingClientRect();if(i>=a.left&&i<=a.right&&s>=a.top&&s<=a.bottom){n=c;break}}n?(this.swipeTargetElement=n,this.swipeTargetIconId=n.getAttribute("data-icon-id"),this.swipeStartY=s,this.swipeStartX=i,this.isSwipeDetected=!1,this.isUpSwipeInProgress=!1,n.classList.add("mb-touch-active")):(this.swipeTargetElement=null,this.swipeTargetIconId=null,this.swipeStartY=0,this.swipeStartX=0)},{passive:!0}),this.core.container.addEventListener("touchmove",t=>{if(!this.swipeTargetElement||this.swipeStartY===0)return;const e=t.touches[0],i=this.swipeStartY-e.clientY,s=Math.abs(e.clientX-this.swipeStartX);if(i>15&&s<40&&(this.isUpSwipeInProgress=!0,this.swipeTargetElement.classList.contains("swiping-up")||this.swipeTargetElement.classList.add("swiping-up"),i>25&&(this.core.container.style.overflowX="hidden",t.preventDefault(),t.stopPropagation()),i>this.minSwipeDistance&&(this.isSwipeDetected=!0,navigator.vibrate&&this.userHasInteracted&&!window.matchMedia("(prefers-reduced-motion: reduce)").matches)))try{navigator.vibrate(20)}catch{}},{passive:!1}),this.core.container.addEventListener("touchend",t=>{this.core.container.style.overflowX="auto",this.swipeTargetElement&&this.swipeTargetElement.classList.remove("mb-touch-active","swiping-up"),this.isSwipeDetected&&this.swipeTargetIconId&&(console.log(`Свайп вверх обнаружен на иконке: ${this.swipeTargetIconId}`),this.showPopup(this.swipeTargetIconId)),this.swipeTargetElement=null,this.swipeStartY=0,this.swipeStartX=0,this.isSwipeDetected=!1,this.isUpSwipeInProgress=!1,this.swipeTargetIconId=null})}getCenteredItem(){return null}showPopup(t){const e=this.popupConfigs[t];if(!(!e||this.isPopupOpen)&&(this.currentPopupConfig=e,this.isPopupOpen=!0,this.blockBodyScroll(),this.currentIconId=t,this.renderPopupContent(e,t),requestAnimationFrame(()=>{this.backdrop.style.opacity="1",this.backdrop.style.visibility="visible",this.popupContainer.style.opacity="1",this.popupContainer.style.visibility="visible",this.popupContainer.style.transform="translateX(-50%) translateY(0)"}),navigator.vibrate&&this.userHasInteracted&&!window.matchMedia("(prefers-reduced-motion: reduce)").matches))try{navigator.vibrate(50)}catch{}}renderPopupContent(t,e){this.popupContainer.className="mb-popup-container mb-popup-swipeable",this.popupContainer.classList.add(`popup-for-${e}`),this.getIconTitle(e),this.popupContainer.innerHTML=`
            <div class="mb-swipe-indicator"></div>
           
            <div class="mb-popup-grid">
                ${t.items.map((i,s)=>`
                        <a ${i.isModal?`href="javascript:void(0);" data-modal="true" data-modal-target="${i.modalId}" class="mb-popup-item modal-trigger no-spinner"`:`href="${i.href}" class="mb-popup-item"`} style="animation-delay: ${s*.1}s;">
                            <img src="/images/icons/${i.icon}" 
                                alt="${i.title}" 
                                title="${i.title}"
                                onerror="this.src='/images/icons/placeholder.svg'; this.classList.add('fallback-icon');"
                                onload="this.classList.add('loaded-icon');">
                            <span class="popup-item-title">${i.title}</span>
                        </a>
                    `).join("")}
            </div>
        `,this.ensureAnimationStyles(),this.setupPopupEventListeners()}getIconTitle(t){if(this.popupConfigs[t]&&this.popupConfigs[t].title)return this.popupConfigs[t].title;const e=this.core.iconsContainer.querySelector(`[data-icon-id="${t}"]`);if(e){const i=e.querySelector("img");if(i&&i.alt)return i.alt;const s=e.querySelector("a");if(s&&s.title)return s.title}return t?t.charAt(0).toUpperCase()+t.slice(1):""}setupPopupEventListeners(){this.popupContainer.addEventListener("click",e=>{e.target.closest(".mb-popup-grid")||(e.preventDefault(),this.closePopup())}),this.popupContainer.querySelectorAll(".mb-popup-item").forEach(e=>{e.hasAttribute("data-modal-target")?e.addEventListener("click",i=>{i.preventDefault();const s=e.getAttribute("data-modal-target");console.log("Сохраняем связь для модалки",s,"с иконкой",this.currentIconId),this.modalTriggers.set(s,{element:this.swipeTargetElement,iconId:this.currentIconId}),this.closePopup(),setTimeout(()=>{window.openModalPanel&&window.openModalPanel(s)},300)}):e.addEventListener("click",()=>{this.closePopup()})})}ensureAnimationStyles(){if(!document.querySelector("#mb-popup-animations")){const t=document.createElement("style");t.id="mb-popup-animations",t.textContent=`
                .mb-popup-item {
                      transform: translateY(20px);
    opacity: 0;
    animation: slideUpFade 0.3s ease forwards;
    display: flex
;
    flex-direction: row;
    align-items: center;
    gap: 5px;
    align-content: center;
    justify-content: flex-start;
                }
                .popup-item-title {
                   font-size: 16px;
    text-align: center;
    color: #333;
    margin-top: 0;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
                }
                @keyframes slideUpFade {
                    to {
                        transform: translateY(0);
                        opacity: 1;
                    }
                }
                .mb-popup-item .fallback-icon {
                    opacity: 0.4;
                    filter: grayscale(1);
                }
                .mb-popup-item .loaded-icon {
                    opacity: 1;
                    filter: none;
                }
                .mb-popup-item img {
                    transition: all 0.3s ease;
                    width: 32px;
                    height: 32px;
                }
                
                /* Стили для класса mb-touch-active и swiping-up */
                .mb-icon-wrapper.mb-touch-active {
                    opacity: 0.8;
                    transform: scale(0.95);
                    transition: all 0.2s ease;
                }
                
                .mb-icon-wrapper.swiping-up {
                    transform: scale(0.92);
                }
                
                .mb-icon-wrapper.swiping-up::after {
                    content: '';
                    position: absolute;
                    top: -8px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 0;
                    height: 0;
                    border-left: 6px solid transparent;
                    border-right: 6px solid transparent;
                    border-bottom: 8px solid rgba(0, 123, 255, 0.6);
                    animation: pulse 1s infinite;
                }
                
                @keyframes pulse {
                    0% { opacity: 0.4; }
                    50% { opacity: 1; }
                    100% { opacity: 0.4; }
                }
                
                /* Стили для заголовка попапа */
                .mb-popup-title {
                    margin: 0;
                    padding: 12px 20px 0;
                    text-align: center;
                    font-weight: 600;
                    font-size: 1rem;
                    color: #333;
                }
                
                /* Стили для кнопки "назад" */
                .mb-icon-wrapper.back-button-active {
                    position: relative;
                    transform: scale(1.05);
                    transition: all 0.3s ease;
                }
                
                .mb-icon-wrapper.back-button-active::after {
                    content: '';
                    position: absolute;
                    bottom: -8px;
                    left: 50%;
                    width: 6px;
                    height: 6px;
                    background-color: #007bff;
                    border-radius: 50%;
                    transform: translateX(-50%);
                    animation: pulse 1.5s infinite;
                }
                
                .mb-icon-wrapper.back-button-active .mb-nav-icon {
                    filter: brightness(1.2);
                    animation: backButtonPulse 2s infinite;
                }
                
                @keyframes backButtonPulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.1); }
                }
            `,document.head.appendChild(t)}}closePopup(){this.isPopupOpen&&(this.backdrop.style.opacity="0",this.backdrop.style.visibility="hidden",this.popupContainer.style.opacity="0",this.popupContainer.style.transform="translateX(-50%) translateY(100px)",setTimeout(()=>{this.popupContainer.style.visibility="hidden",this.isPopupOpen=!1,this.currentPopupConfig=null,this.currentIconId&&!document.querySelector(".modal-panel.show")&&window.MobileNavWheelPicker&&window.MobileNavWheelPicker.core&&(window.MobileNavWheelPicker.core.restoreIcon(this.currentIconId),this.currentIconId=null),this.unblockBodyScroll()},400))}blockBodyScroll(){const t=window.location.pathname;if(t.includes("/templates/create-new/")||t.includes("/templates/editor")||t.includes("/client/templates/create-new/")||t.includes("/client/templates/editor")){console.log("Блокировка скролла пропущена на странице редактора");return}this.scrollY=window.pageYOffset||document.documentElement.scrollTop,this.originalBodyOverflow=document.body.style.overflow,this.originalBodyPosition=document.body.style.position,document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.top=`-${this.scrollY}px`,document.body.style.width="100%",document.body.classList.add("popup-scroll-blocked")}unblockBodyScroll(){document.body.classList.contains("popup-scroll-blocked")&&(document.body.style.overflow=this.originalBodyOverflow,document.body.style.position=this.originalBodyPosition,document.body.style.top="",document.body.style.width="",document.body.classList.remove("popup-scroll-blocked"),this.scrollY>0&&window.scrollTo(0,this.scrollY),this.scrollY=0,this.originalBodyOverflow="",this.originalBodyPosition="")}blockHorizontalScroll(){return this.isUpSwipeInProgress}}class w{constructor(){this.storageKey="mobileNavState",this.routeToIconMap=this.createRouteMapping(),this.storageAvailable=this.checkStorageAvailability()}checkStorageAvailability(){try{const t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch{return!1}}createRouteMapping(){return{"/":"home","/home":"home","/user/templates":"profile","/profile":"profile","/client/templates/categories":"create","/client/templates":"create","/client/projects":"create","/client/images":"create","/admin/dashboard":"admin","/admin":"admin","/games":"games","/email":"email"}}getIconForCurrentPage(){const t=window.location.pathname;if(this.routeToIconMap[t])return this.routeToIconMap[t];for(const[e,i]of Object.entries(this.routeToIconMap))if(e!=="/"&&t.startsWith(e))return i;return null}getPriorityIcon(){const t=this.getIconForCurrentPage();return t||"home"}clearExpiredData(){if(this.storageAvailable)try{const t=localStorage.getItem(this.storageKey);if(t){const e=JSON.parse(t);(!e||!e.timestamp||Date.now()-e.timestamp>24*60*60*1e3)&&localStorage.removeItem(this.storageKey)}}catch(t){console.warn("Ошибка при очистке устаревших данных навигации:",t);try{localStorage.removeItem(this.storageKey)}catch{}}}}class y{constructor(t,e){this.core=t,this.scroll=e}getScrollBounds(){const t=this.core.container.offsetWidth,e=this.core.iconsContainer.scrollWidth,i=e-t;return{containerWidth:t,scrollWidth:e,maxScrollLeft:i,currentScrollLeft:this.core.container.scrollLeft,sidePadding:this.core.sidePadding}}getMaxScrollForLastItem(){if(this.core.items.length===0)return 0;const t=this.core.items[this.core.items.length-1],e=this.core.container.offsetWidth,i=t.offsetLeft-e/2+t.offsetWidth/2;return Math.max(0,i)}setupIntersectionObserver(){if(!("IntersectionObserver"in window))return;const t={root:this.core.container,rootMargin:"0px",threshold:.5},e=new IntersectionObserver(i=>{i.forEach(s=>{s.isIntersecting?s.target.classList.add("mb-visible"):s.target.classList.remove("mb-visible")})},t);document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".mb-icon-wrapper").forEach(s=>e.observe(s))})}}class I{constructor(){this.core=new f,this.storage=new w,this.scroll=new v(this.core),this.popup=new b(this.core),this.utils=new y(this.core,this.scroll),this.events=new g(this.core,this.scroll,this.popup),window.MobileNavWheelPicker=this,this.initModalIntegration()}initModalIntegration(){document.addEventListener("modal.opened",t=>{var s,o;const e=(s=t.detail)==null?void 0:s.modalId,i=(o=t.detail)==null?void 0:o.sourceIconId;if(e&&i){console.log(`MobileNav: Модальное окно ${e} открыто из иконки ${i}`);const n=document.querySelector(`[data-icon-id="${i}"]`);n&&n.classList.add("modal-source-active")}}),document.addEventListener("modal.closed",t=>{document.querySelectorAll(".modal-source-active").forEach(e=>{e.classList.remove("modal-source-active")})})}}document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>new I,100)});
